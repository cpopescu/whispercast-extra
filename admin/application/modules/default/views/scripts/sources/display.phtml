<tal:block phptal:tales="php">
<div id="default-sources-index-container">
  <div id="default-sources-index-results" style="margin: 1em"></div>
</div>

<script type="text/javascript">
sandbox.server = ${structure json_encode(server)};
</script>

<tal:block metal:use-macro="../streams/library.phtml/Default_Streams_Table"/>

<script type="text/javascript">
<!--
sandbox.run = function() {
  Whispercast.Resolver.resolve(['Whispercast.table'], [], {done: function() {
    Default_Streams_Table();

    YAHOO.util.Event.onContentReady('default-sources-index-container', function(e) {
      sandbox.table = new Whispercast.Lib.Default.Streams.Table( {
        container: 'default-sources-index-results',
        columns:
        {
          0: false,
          4:
          {key: 'publish', label: _('Publish to'),
            formatter: function(el, record, column, data) {
              var response = this._response;
              if (response && response.meta && response.meta.server) {
                el.innerHTML = Whispercast.htmlEscape('s'+response.meta.server.id+'_'+response.meta.server.version+'_'+record.getData('protocol')+'_source/'+record.getData('source'));
              }
            }
          }
        },
        config:
        {
          dynamicData: true,
          initialLoad:{
            request: 'pageCurrent=1&pagePerPage=10&sortBy=category&sortOrder=1'
          },
          sortedBy:{
            key: 'category',
            dir: YAHOO.widget.DataTable.CLASS_ASC
          }
        },
        serverId: sandbox.server.id,
        links:
        [
          '<button id="default-sources-index-results-add">'+_('Add a new source...')+'</button>',
          '<button id="default-sources-index-results-reload">'+_('Reload')+'</button>'
        ],
        query:
        {
          f: {
            type: ['sources']
          }
        }
      });


      sandbox.table.run(Whispercast.closure(this, function() {
        YAHOO.util.Event.on('default-sources-index-results-add', 'click', function() {
          Whispercast.App.retrieveContent('',Whispercast.Uri.buildZend('default', 'sources', 'add', sandbox.server.id));
        });
        YAHOO.util.Event.on('default-sources-index-results-reload', 'click', function() {
          sandbox.table.reload();
        });

        sandbox.initialized ? sandbox.initialized.call(sandbox) : false;
      }));
    });
  }});
};
sandbox.destroy = function() {
  if (sandbox.table) {
    sandbox.table.destroy();
  }

  YAHOO.util.Event.purgeElement(document.getElementById('default-sources-index-container'), true);
  sandbox.destroyed ? sandbox.destroyed.call(sandbox) : false;
};
//-->
</script>
</tal:block>
